<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.gnet.app.storageOut.StorageOutMapper">
	<resultMap id="BaseStorageOutMap" type="com.gnet.app.storageOut.StorageOut">
		<id column="id" property="id" jdbcType="CHAR" />
		<result column="create_date" property="createDate" />
		<result column="modify_date" property="modifyDate" />
		<result column="type" property="type" jdbcType="INTEGER" />
		<result column="business_id" property="businessId" jdbcType="CHAR" />
		<result column="clerk_id" property="clerkId" jdbcType="CHAR" />
		<result column="order_id" property="orderId" jdbcType="CHAR"/>
		<result column="batch_number" property="batchNumber" jdbcType="VARCHAR" />
		<result column="change_date" property="changeDate" />
		<result column="remark" property="remark" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="StorageOutExtMap" type="com.gnet.app.storageOut.StorageOut"
		extends="BaseStorageOutMap">
		<result column="type_name" property="typeName" jdbcType="VARCHAR" />
		<result column="out_total_num" property="outTotalNum" jdbcType="DECIMAL" />
		<association property="clerk"  javaType="com.gnet.app.clerk.Clerk">  
            <result property="name" column="clerk_name"/>  
        </association>
	</resultMap>


	<select id="selectStorageOutHistoryDataListByCondition"
		resultMap="StorageOutExtMap" parameterType="com.gnet.app.storageOut.StorageOutCondition">
		SELECT
		t.*, s.name clerk_name, 
		(select sa.value from sc_codeword sa,sc_codeword_type sb 
		where sb.id=sa.codeword_type_id and sa.code=t.type and sb.type_value = 'STORAGE_OUT_SOURCE') type_name,
		(select sum(w.num) from ykj_storage_out_detail w where w.storage_out_id = t.id) out_total_num
		FROM
		ykj_storage_out t
		LEFT JOIN ykj_clerk s ON t.clerk_id = s.id
		<where>
			<if test="type != null">
				and t.type = #{type}
			</if>
			<if test="businessId != null and businessId !='' ">
				and t.business_id = #{businessId}
			</if>
			<if test="clerkId != null and clerkId !='' ">
				and t.clerk_id = #{clerkId}
			</if>
			<if test="orderId != null and orderId !='' ">
                and t.order_id = #{orderId}
            </if>
			<if test="fuzzyBatchNumber != null and fuzzyBatchNumber !='' ">
				and t.batch_number like
				CONCAT('%',CONCAT(#{fuzzyBatchNumber},'%'))
			</if>
			<if test="storageOutStartDate != null ">
				and t.change_date >= DATE_FORMAT(#{storageOutStartDate},'%Y-%m-%d')
			</if>
			<if test="storageOutEndDate != null ">
                <![CDATA[and t.change_date <= DATE_FORMAT(#{storageOutEndDate},'%Y-%m-%d')]]>
			</if>
		</where>
	</select>
	
	<select id="selectStorageOutGoodHistoryDataListByCondition"
		resultMap="StorageOutExtMap" parameterType="com.gnet.app.storageOut.StorageOutCondition">
		SELECT
		t.*, s.name clerk_name, 
		(select sa.value from sc_codeword sa,sc_codeword_type sb 
		where sb.id=sa.codeword_type_id and sa.code=t.type and sb.type_value = 'STORAGE_OUT_SOURCE') type_name,
		(select sum(w.num) from ykj_storage_out_detail w where w.storage_out_id = t.id and w.storage_goods_id = q.storage_goods_id) out_total_num
		FROM
		ykj_storage_out t
		LEFT JOIN ykj_clerk s ON t.clerk_id = s.id
		LEFT JOIN ykj_storage_out_detail q on q.storage_in_id = t.id 
		<where>
			<if test="type != null">
				and t.type = #{type}
			</if>
			<if test="businessId != null and businessId !='' ">
				and t.business_id = #{businessId}
			</if>
			<if test="clerkId != null and clerkId !='' ">
				and t.clerk_id = #{clerkId}
			</if>
			<if test="orderId != null and orderId !='' ">
                and t.order_id = #{orderId}
            </if>
			<if test="fuzzyBatchNumber != null and fuzzyBatchNumber !='' ">
				and t.batch_number like
				CONCAT('%',CONCAT(#{fuzzyBatchNumber},'%'))
			</if>
			<if test="storageOutStartDate != null ">
				and t.change_date >= DATE_FORMAT(#{storageOutStartDate},'%Y-%m-%d')
			</if>
			<if test="storageOutEndDate != null ">
                <![CDATA[and t.change_date <= DATE_FORMAT(#{storageOutEndDate},'%Y-%m-%d')]]>
			</if>
			<if test="goodId != null and goodId !='' ">
				and q.storage_goods_id = #{goodId}
			</if>
		</where>
	</select>

</mapper>